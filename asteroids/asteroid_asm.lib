'
'	Assembler routines
'
proc Machine.Code()
	memSize = 1024
	codeSpace = alloc(memSize)
	oList = $FE:ob1 = $FC:ob2 = $FA
	CParam = $FF04
	for pass = 0 to 1
		o = pass * 1:p = codeSpace
		call AsmMoveDrawCurrent()
		call AsmMoveDrawAll()
	next
	assert p-codeSpace+128 < memSize
endproc
'
proc AsmMoveDrawAll()
	.ASMoveDrawAll
		dec
		pha:jsr ASMoveDraw:pla
		cmp #0:bne ASMoveDrawAll
		rts
endproc
'
proc AsmMoveDrawCurrent()

	.ASMoveDraw
		asl:tay
		lda (oList),y:sta ob1:clc:adc #2:sta ob2
		iny:lda (oList),y:sta ob1+1:adc #0:sta ob2+1
		lda (ob1):beq ASMDExit

		' Move
		ldy #2:ldx #160:jsr ASMAdd
		ldy #6:ldx #120:jsr ASMAdd


		' Process the left/right wrap, vertical is fine as is.
		ldy #3
		lda (ob1),y
		cmp #168:bcc ASNotOver1:cmp #248:bcs ASNotOver1
		adc #248-168:bmi ASNotOver1:sbc # (248-168)*2
	.ASNotOver1
		sta (ob1),y

		' Repaint
		ldy #12:lda (ob1),y:sta CParam+0
		ldy #2:lda (ob1),y:asl:iny:lda (ob1),y:rol
		sta CParam+1:lda #0:adc #0:sta CParam+2
		ldy #6:lda (ob1),y:asl:iny:lda (ob1),y:rol
		sta CParam+3:stz CParam+4
		lda (ob1):and #$7F:sta CParam+5
		stz CParam+6:stz CParam+7
		call Send.Message(6,2)
	.ASMDExit		
		rts
	.ASMAdd
		clc
		lda (ob1),y:adc (ob2),y:sta (ob1),y
		iny
		lda (ob1),y:adc (ob2),y:sta (ob1),y
		rts
endproc
'
proc Debug()
	poke p,3:p = p + 1
endproc
'
proc Send.Message(group,func)
	jsr 	$FFF7
	poke p,group:poke p+1,func:p = p + 2
	jsr 	$FFF4
endproc